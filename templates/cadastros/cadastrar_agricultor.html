{% extends 'base.html' %}
{% load static %}

{% block title %}Cadastro de Agricultores | EXTENSÃƒO AmazÃ´nia{% endblock %}

{% block content %}
<section class="content-header">
  <div class="container-fluid">
    <h1><i class="fas fa-tractor text-success"></i> Cadastro de Agricultores e Agricultoras</h1>
    <p class="text-muted">FormulÃ¡rio tÃ©cnico de levantamento socioeconÃ´mico de famÃ­lias vinculadas ao projeto.</p>
  </div>
</section>

<section class="content">
  <div class="container-fluid">

     <div id="status-conexao" class="alert text-center shadow" style="display: none;"></div>


    <form method="post">
      {% csrf_token %}
      <div class="card card-outline card-success shadow">
        <div class="card-header">
          <h3 class="card-title"><i class="fas fa-leaf"></i> InformaÃ§Ãµes Gerais</h3>
        </div>
        <div class="card-body">

          <!-- SeÃ§Ã£o: Dados da Feira -->
          <fieldset class="border p-3 mb-4">
            <legend class="w-auto text-success"><i class="fas fa-store-alt"></i> Dados da Feira</legend>
            <div class="row">
              <div class="form-group col-md-6">
                <label>ğŸ“ Local da Feira</label>
                <input type="text" name="local_feira" class="form-control">
              </div>
              <div class="form-group col-md-3">
                <label>ğŸ“… Data</label>
                <input type="date" name="data" class="form-control">
              </div>
              <div class="form-group col-md-3">
                <label>ğŸ”¢ NÂº da Ficha</label>
                <input type="text" name="numero_ficha" class="form-control">
              </div>
            </div>

            <div class="form-group">
              <label>ğŸ‘¤ Entrevistador</label>
              <input type="text" name="entrevistador" class="form-control" value="{{ request.user.username }}" readonly>


            </div>


          </fieldset>

          <!-- SeÃ§Ã£o: InformaÃ§Ãµes Pessoais -->
          <fieldset class="border p-3 mb-4">
            <legend class="w-auto text-primary"><i class="fas fa-user"></i> Perfil do Feirante</legend>
            <div class="form-row">
              <div class="form-group col-md-2">
                <label>ğŸ‚ Idade</label>
                <input type="number" name="idade" class="form-control">
              </div>
              <div class="form-group col-md-3">
                <label>âš§ï¸ Sexo</label>
                <select name="sexo" class="form-control">
                  <option>Masculino</option>
                  <option>Feminino</option>
                  <option>Outro</option>
                </select>
              </div>

              <div class="form-group col-md-4">
  <label for="escolaridade"><strong>ğŸ“ Escolaridade</strong></label>
  <select name="escolaridade" id="escolaridade" class="form-control">
    <option value="">Selecione...</option>
    <option value="NÃ£o alfabetizado">NÃ£o alfabetizado</option>
    <option value="Fund. Incompleto">Fund. Incompleto</option>
    <option value="Fund. Completo">Fund. Completo</option>
    <option value="MÃ©dio Incompleto">MÃ©dio Incompleto</option>
    <option value="MÃ©dio Completo">MÃ©dio Completo</option>
    <option value="Sup. Incompleto">Sup. Incompleto</option>
    <option value="Sup. Completo">Sup. Completo</option>
  </select>
</div>



              <div class="form-group col-md-3">
                <label>ğŸ˜ï¸ Cidade de Origem</label>
                <input type="text" name="cidade_origem" class="form-control">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-6">
                <label>â±ï¸ Tempo na Feira em anos</label>
                <input type="text" name="tempo_feira" class="form-control">
              </div>
              <div class="form-group col-md-6">
                <label>ğŸ§­ Participa de outras feiras?</label><br>
                <input type="checkbox" name="varias_feiras" value="1"> Sim
              </div>
            </div>
          </fieldset>

          <!-- SeÃ§Ã£o: RelaÃ§Ãµes Familiares -->
<fieldset class="border p-3 mb-4">
  <legend class="w-auto text-warning">
    <i class="fas fa-users"></i> OrganizaÃ§Ã£o Familiar do Trabalho
  </legend>

  <div class="form-row">
    <div class="form-group col-md-6">
      <label>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Trabalha com familiares?</label><br>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="trabalha_familiares" value="1" id="check_familiares">
        <label class="form-check-label" for="check_familiares">Sim</label>
      </div>
    </div>

    <div class="form-group col-md-6">
      <label>ğŸ‘¥ NÂº de familiares envolvidos</label>
      <input type="number" name="qtd_familiares" class="form-control" min="0">
    </div>
  </div>

  <div class="form-group">
    <label><strong>ğŸ“‘ Grau de parentesco</strong></label>
    <div class="d-md-flex flex-wrap gap-2">
      <div class="form-check mr-3">
        <input class="form-check-input" type="radio" name="grau_parentesco" id="parentesco1" value="CÃ´njuge">
        <label class="form-check-label" for="parentesco1">CÃ´njuge</label>
      </div>
      <div class="form-check mr-3">
        <input class="form-check-input" type="radio" name="grau_parentesco" id="parentesco2" value="Filhos">
        <label class="form-check-label" for="parentesco2">Filhos</label>
      </div>
      <div class="form-check mr-3">
        <input class="form-check-input" type="radio" name="grau_parentesco" id="parentesco3" value="Pais">
        <label class="form-check-label" for="parentesco3">Pais</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="grau_parentesco" id="parentesco_outros" value="" onclick="toggleOutroParentesco(true)">
        <label class="form-check-label" for="parentesco_outros">Outros</label>
      </div>
    </div>
    <input type="text" class="form-control mt-2" id="input_outro_parentesco" name="outro_parentesco" placeholder="Informe o grau de parentesco" oninput="setOutroParentesco(this.value)" style="display: none;">
  </div>

  <div class="form-row">
    <div class="form-group col-md-6">
      <label>ğŸ§’ CrianÃ§as ajudam?</label>
      <div class="form-check">
        <input type="checkbox" class="form-check-input" name="criancas_ajudam" value="1" id="check_criancas">
        <label class="form-check-label" for="check_criancas">Sim</label>
      </div>
      <input type="text" name="atividades_criancas" class="form-control mt-2" placeholder="Quais atividades?">
    </div>

    <div class="form-group col-md-6">
      <label>ğŸ§“ Idosos ajudam?</label>
      <div class="form-check">
        <input type="checkbox" class="form-check-input" name="idosos_ajudam" value="1" id="check_idosos">
        <label class="form-check-label" for="check_idosos">Sim</label>
      </div>
      <input type="text" name="atividades_idosos" class="form-control mt-2" placeholder="Quais atividades?">
    </div>
  </div>
</fieldset>




          <!-- SeÃ§Ã£o: ProduÃ§Ã£o e Renda -->
<fieldset class="border p-3 mb-4">
  <legend class="w-auto text-danger">
    <i class="fas fa-coins"></i> Renda e Economia
  </legend>

  <!-- Produto principal e origem -->
  <div class="form-row">
    <div class="form-group col-md-6">
      <label>ğŸŒ¾ Produto principal</label>
      <input type="text" name="produto_principal" class="form-control">
    </div>

    <div class="form-group col-md-6">
      <label><strong>ğŸ“¦ Origem do produto</strong></label><br>
      <div class="d-flex flex-wrap">
        <div class="form-check mr-3">
          <input class="form-check-input" type="radio" name="origem_produto" id="origem1" value="Produzido">
          <label class="form-check-label" for="origem1">Produzido</label>
        </div>
        <div class="form-check mr-3">
          <input class="form-check-input" type="radio" name="origem_produto" id="origem2" value="Revenda">
          <label class="form-check-label" for="origem2">Revenda</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="origem_produto" id="origem3" value="Ambos">
          <label class="form-check-label" for="origem3">Ambos</label>
        </div>
      </div>
    </div>
  </div>

  <!-- Faturamento -->
  <div class="form-group">
    <label><strong>ğŸ’° Faturamento mÃ©dio semanal</strong></label>
    <div class="d-flex flex-wrap">
      <div class="form-check mr-3">
        <input class="form-check-input" type="radio" name="faturamento" id="fat1" value="atÃ© R$300">
        <label class="form-check-label" for="fat1">atÃ© R$300</label>
      </div>
      <div class="form-check mr-3">
        <input class="form-check-input" type="radio" name="faturamento" id="fat2" value="R$301â€“600">
        <label class="form-check-label" for="fat2">R$301â€“600</label>
      </div>
      <div class="form-check mr-3">
        <input class="form-check-input" type="radio" name="faturamento" id="fat3" value="R$601â€“1.000">
        <label class="form-check-label" for="fat3">R$601â€“1.000</label>
      </div>
      <div class="form-check mr-3">
        <input class="form-check-input" type="radio" name="faturamento" id="fat4" value="R$1.001â€“2.000">
        <label class="form-check-label" for="fat4">R$1.001â€“2.000</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="faturamento" id="fat5" value="acima de R$2.000">
        <label class="form-check-label" for="fat5">acima de R$2.000</label>
      </div>
    </div>
  </div>

  <!-- Custos principais -->
  <div class="form-group">
    <label><strong>ğŸ“‰ Custos principais</strong></label>
    <div class="d-flex flex-column flex-md-row flex-wrap gap-3">
      <div class="form-check mr-4">
        <input class="form-check-input" type="checkbox" name="custos_principais[]" id="custo1" value="Transporte">
        <label class="form-check-label" for="custo1">Transporte</label>
      </div>
      <div class="form-check mr-4">
        <input class="form-check-input" type="checkbox" name="custos_principais[]" id="custo2" value="Compra de produtos">
        <label class="form-check-label" for="custo2">Compra de produtos</label>
      </div>
      <div class="form-check mr-4">
        <input class="form-check-input" type="checkbox" name="custos_principais[]" id="custo3" value="Aluguel">
        <label class="form-check-label" for="custo3">Aluguel</label>
      </div>
      <div class="form-check mr-4">
        <input class="form-check-input" type="checkbox" name="custos_principais[]" id="custo4" value="Energia/Ã¡gua">
        <label class="form-check-label" for="custo4">Energia/Ã¡gua</label>
      </div>
      <div class="form-check w-100 mt-2">
        <input class="form-check-input" type="checkbox" id="custo_outros" value="" onclick="toggleOutroCusto(this.checked)">
        <label class="form-check-label" for="custo_outros">Outros:</label>
        <input type="text" class="form-control mt-2" id="input_outro_custo" placeholder="Descreva..." oninput="setOutroCusto(this.value)" style="display: none;">
      </div>
    </div>
  </div>

  <!-- VariaÃ§Ã£o de renda -->
  <div class="form-group">
    <label><strong>ğŸ“Š A renda varia?</strong></label><br>
    <div class="form-check">
      <input type="checkbox" class="form-check-input" name="renda_varia" value="1" id="rendaVariaCheck">
      <label class="form-check-label" for="rendaVariaCheck">Sim</label>
    </div>
  </div>

  <!-- Meses bons/fracos -->
  <div class="form-row">
    <div class="form-group col-md-6">
      <label>ğŸ“ˆ Meses bons</label>
      <input type="text" name="meses_bons" class="form-control">
    </div>
    <div class="form-group col-md-6">
      <label>ğŸ“‰ Meses fracos</label>
      <input type="text" name="meses_fracos" class="form-control">
    </div>
  </div>
</fieldset>







          <!-- SeÃ§Ã£o: Estrutura da Feira -->
<fieldset class="border p-3 mb-4">
  <legend class="w-auto text-secondary"><i class="fas fa-tools"></i> Estrutura da Feira</legend>

  <!-- CondiÃ§Ã£o de Acesso -->
  <div class="form-group">
  <label><strong>ğŸ›£ï¸ CondiÃ§Ã£o de Acesso ao Local</strong></label><br>
  <div class="d-flex flex-wrap gap-3">
    {% for val in opcoes_acesso %}
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="acesso" id="acesso_{{ forloop.counter }}" value="{{ val }}">
      <label class="form-check-label" for="acesso_{{ forloop.counter }}">{{ val }}</label>
    </div>
    {% endfor %}
  </div>
</div>


  <!-- Ãgua e Banheiro -->
  <div class="form-row mb-3">
    <div class="form-check mr-4">
      <input type="checkbox" name="agua" value="1" class="form-check-input" id="aguaCheck">
      <label class="form-check-label" for="aguaCheck">ğŸ’§ Ãgua disponÃ­vel</label>
    </div>
    <div class="form-check">
      <input type="checkbox" name="banheiro" value="1" class="form-check-input" id="banheiroCheck">
      <label class="form-check-label" for="banheiroCheck">ğŸš» Banheiro</label>
    </div>
  </div>

  <!-- Higiene -->
  <div class="form-group">
  <label><strong>ğŸ§¼ CondiÃ§Ãµes de higiene do local</strong></label><br>
  <div class="d-flex flex-wrap gap-3">
    {% for val in opcoes_higiene %}
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="higiene" id="higiene_{{ forloop.counter }}" value="{{ val }}">
      <label class="form-check-label" for="higiene_{{ forloop.counter }}">{{ val }}</label>
    </div>
    {% endfor %}
  </div>
</div>


  <!-- SeguranÃ§a -->
  <div class="form-group">
    <label><strong>ğŸ” SeguranÃ§a no local</strong></label>
    <div class="form-check mb-2">
      <input type="checkbox" name="seguranca" value="1" class="form-check-input" id="segurancaCheck">
      <label class="form-check-label" for="segurancaCheck">Sente-se seguro?</label>
    </div>
    <input type="text" name="motivo_inseguranca" class="form-control" placeholder="Se nÃ£o, explique.">
  </div>
</fieldset>





          <!-- SeÃ§Ã£o: OrganizaÃ§Ã£o e PolÃ­ticas PÃºblicas -->
          <fieldset class="border p-3 mb-4">
            <legend class="w-auto text-dark"><i class="fas fa-handshake"></i> OrganizaÃ§Ã£o e Apoios</legend>
            <div class="form-group">
              <label>ğŸ‘¥ Participa de associaÃ§Ã£o?</label>
              <input type="checkbox" name="associacao" value="1"> Sim
              <input type="text" name="nome_associacao" class="form-control mt-1" placeholder="Nome da associaÃ§Ã£o">
            </div>
            <div class="form-group">
              <label>ğŸ“ JÃ¡ participou de capacitaÃ§Ã£o?</label>
              <input type="checkbox" name="capacitacao" value="1"> Sim
              <input type="text" name="capacitador" class="form-control mt-1" placeholder="Quem capacitou?">
            </div>

            <div class="form-group">
  <label><strong>ğŸ›ï¸ Recebe apoio de polÃ­ticas pÃºblicas?</strong></label>
  <div class="d-flex flex-column flex-md-row flex-wrap gap-3">
    <div class="form-check mr-4">
      <input class="form-check-input" type="checkbox" name="apoio_publico[]" id="apoio1" value="Bolsa FamÃ­lia / AuxÃ­lio Brasil">
      <label class="form-check-label" for="apoio1">Bolsa FamÃ­lia / AuxÃ­lio Brasil</label>
    </div>
    <div class="form-check mr-4">
      <input class="form-check-input" type="checkbox" name="apoio_publico[]" id="apoio2" value="CrÃ©dito Rural / Pronaf">
      <label class="form-check-label" for="apoio2">CrÃ©dito Rural / Pronaf</label>
    </div>
    <div class="form-check mr-4">
      <input class="form-check-input" type="checkbox" name="apoio_publico[]" id="apoio3" value="Apoio municipal">
      <label class="form-check-label" for="apoio3">Apoio municipal</label>
    </div>
    <div class="form-check w-100 mt-2">
      <input class="form-check-input" type="checkbox" id="apoio_outros" value="" onclick="toggleOutroApoio(this.checked)">
      <label class="form-check-label" for="apoio_outros">Outros:</label>
      <input type="text" class="form-control mt-2" id="input_outro_apoio" placeholder="Descreva..." oninput="setOutroApoio(this.value)" style="display: none;">
    </div>
  </div>
</div>


            <div class="form-group">
              <label>ğŸ¦ Acesso a crÃ©dito?</label>
              <input type="checkbox" name="acesso_credito" value="1"> Sim
              <input type="text" name="instituicao_credito" class="form-control mt-1" placeholder="InstituiÃ§Ã£o de crÃ©dito">
            </div>
          </fieldset>

        </div>

        <div class="card-footer d-flex justify-content-end">
          <button type="submit" class="btn btn-success">
            <i class="fas fa-save"></i> Salvar Cadastro
          </button>
        </div>
      </div>
    </form>
  </div>
</section>



<script>
  function toggleOutroParentesco(show) {
    const input = document.getElementById('input_outro_parentesco');
    input.style.display = show ? 'block' : 'none';
    if (show) input.focus();
  }

  function setOutroParentesco(value) {
    document.getElementById('parentesco_outros').value = value;
  }

  // Garante ocultar se outro for clicado
  document.querySelectorAll('input[name="grau_parentesco"]').forEach(el => {
    el.addEventListener('change', function () {
      if (this.id !== 'parentesco_outros') {
        toggleOutroParentesco(false);
      }
    });
  });
</script>


<script>
  function toggleOutroCusto(show) {
    const input = document.getElementById('input_outro_custo');
    input.style.display = show ? 'block' : 'none';
    if (!show) input.value = '';
  }

  function setOutroCusto(value) {
    document.getElementById('custo_outros').value = value;
  }
</script>


<script>
  function toggleOutroApoio(show) {
    const input = document.getElementById('input_outro_apoio');
    input.style.display = show ? 'block' : 'none';
    if (!show) input.value = '';
  }

  function setOutroApoio(value) {
    document.getElementById('apoio_outros').value = value;
  }
</script>


<div id="mensagem-sucesso" class="alert alert-success text-center shadow" style="display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999;">
  âœ… Cadastro salvo com sucesso!
</div>

<script>
  const form = document.querySelector("form");
  const STORAGE_KEY = "cadastros_agricultor_offline";

  // Exibe alerta de sucesso se marcado
  if (localStorage.getItem('cadastro_agricultor_sucesso')) {
    localStorage.removeItem('cadastro_agricultor_sucesso');
    const msg = document.getElementById('mensagem-sucesso');
    msg.style.display = 'block';
    setTimeout(() => {
      msg.style.display = 'none';
    }, 4000);
  }

  // Marcar envio bem-sucedido
  if (form) {
    form.addEventListener('submit', function (e) {
      if (!navigator.onLine) {
        e.preventDefault();
        salvarOffline();
      } else {
        localStorage.setItem('cadastro_agricultor_sucesso', '1');
      }
    });
  }

  function salvarOffline() {
    const formData = new FormData(form);
    const dados = {};

    formData.forEach((value, key) => {
      if (key.endsWith("[]")) {
        const cleanKey = key.replace("[]", "");
        dados[cleanKey] = dados[cleanKey] || [];
        dados[cleanKey].push(value);
      } else {
        dados[key] = value;
      }
    });

    let registros = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    registros.push(dados);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(registros));

    alert("âœ… Cadastro salvo localmente! SerÃ¡ sincronizado quando a internet voltar.");
  }

  function sincronizarCadastros() {
    const registros = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    if (registros.length === 0) return;

    registros.forEach(dados => {
      fetch("/sincronizar/agricultor/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify(dados)
      }).then(response => {
        if (response.ok) {
          console.log("âœ… Cadastro sincronizado.");
        }
      });
    });

    localStorage.removeItem(STORAGE_KEY);
  }

  // Status de conexÃ£o
  const statusDiv = document.getElementById("status-conexao");
  function atualizarStatusConexao() {
    if (navigator.onLine) {
      statusDiv.className = "alert alert-success";
      statusDiv.innerText = "âœ… Online â€” envio direto para o servidor";
    } else {
      statusDiv.className = "alert alert-warning";
      statusDiv.innerText = "âš ï¸ Offline â€” os dados serÃ£o salvos localmente";
    }
    statusDiv.style.display = "block";
  }

  window.addEventListener("load", () => {
    atualizarStatusConexao();
    sincronizarCadastros();  // Tenta sincronizar assim que voltar Ã  rede
  });

  window.addEventListener("online", atualizarStatusConexao);
  window.addEventListener("offline", atualizarStatusConexao);
</script>




{% endblock %}
