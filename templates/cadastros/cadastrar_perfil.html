{% extends 'base.html' %}
{% load static %}

{% block title %}Cadastro Socioecon√¥mico | EXTENS√ÉO Amaz√¥nia{% endblock %}

{% block content %}
<section class="content-header">
    <div class="container-fluid">
        <h1><i class="fas fa-users text-primary"></i> Question√°rio Socioecon√¥mico</h1>
        <p class="text-muted">Formul√°rio t√©cnico de levantamento socioecon√¥mico de fam√≠lias tradicionais vinculadas ao
            projeto.</p>
    </div>
</section>

<!-- Elemento HTML da mensagem -->
<div id="status-conexao" class="alert" style="display: none;"></div>


<section class="content">
    <div class="container-fluid">
        <form method="post">
            {% csrf_token %}

            <!-- Card: Entrevistador -->
            <div class="card card-outline card-info shadow mb-4">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-user-check"></i> Identifica√ß√£o do Entrevistador</h3>
                </div>
                <div class="card-body">
                    <div class="form-group mb-0">
                        <label>üë§ Nome do Entrevistador</label>
                        <input type="text" name="entrevistador" class="form-control"
                            value="{{ request.user.get_full_name|default:request.user.username }}" readonly>
                    </div>
                </div>
            </div>

            <!-- Card: Perfil Familiar -->
            <div class="card card-outline card-primary shadow mb-4">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-clipboard-list"></i> Perfil Familiar</h3>
                </div>
                <div class="card-body">

                    <!-- Se√ß√£o I: Identifica√ß√£o Familiar -->
                    <fieldset class="border p-3 mb-4">
                        <legend class="w-auto text-primary"><i class="fas fa-home"></i> Identifica√ß√£o Familiar</legend>

                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>üìç Comunidade/Localidade</label>
                                <input type="text" name="comunidade" class="form-control">
                            </div>
                            <div class="form-group col-md-6">
                                <label>üë®‚Äçüë©‚Äçüëß Nome do Respons√°vel</label>
                                <input type="text" name="nome_responsavel" class="form-control">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label>üë™ N¬∫ de Pessoas na Casa</label>
                                <input type="number" name="qtd_moradores" class="form-control">
                            </div>
                            <div class="form-group col-md-4">
                                <label>‚è±Ô∏è Tempo na Comunidade</label>
                                <input type="text" name="tempo_comunidade" class="form-control">
                            </div>
                            <div class="form-group col-md-4">
                                <label>üß≠ Zona</label>
                                <input type="text" name="zona" class="form-control" placeholder="Rural ou Urbana">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group col-md-3">
                                <label>üßí Crian√ßas (0-12)</label>
                                <input type="number" name="composicao_criancas" class="form-control">
                            </div>
                            <div class="form-group col-md-3">
                                <label>üë¶ Adolescentes (13-17)</label>
                                <input type="number" name="composicao_adolescentes" class="form-control">
                            </div>
                            <div class="form-group col-md-3">
                                <label>üßë Adultos (18-59)</label>
                                <input type="number" name="composicao_adultos" class="form-control">
                            </div>
                            <div class="form-group col-md-3">
                                <label>üë¥ Idosos (60+)</label>
                                <input type="number" name="composicao_idosos" class="form-control">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Se√ß√£o II: Moradia -->
                    <fieldset class="border p-3 mb-4">
                        <legend class="w-auto text-secondary"><i class="fas fa-house-user"></i> Moradia</legend>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>Tipo de Moradia</label>
                                <select name="tipo_moradia" class="form-control">
                                    <option>Pr√≥pria</option>
                                    <option>Alugada</option>
                                    <option>Cedida</option>
                                    <option>Ocupada/Irregular</option>
                                </select>
                            </div>
                            <div class="form-group col-md-6">
                                <label>Tipo de Constru√ß√£o</label>
                                <select name="tipo_construcao" class="form-control">
                                    <option>Alvenaria</option>
                                    <option>Madeira</option>
                                    <option>Taipa/Barro</option>
                                    <option>Outro</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="energia_eletrica" value="1">
                            <label class="form-check-label">Possui energia el√©trica</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="agua_encanada" value="1">
                            <label class="form-check-label">Possui √°gua encanada</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" name="saneamento" value="1">
                            <label class="form-check-label">Possui fossa/sanit√°rio</label>
                        </div>

                        <input type="text" name="destino_lixo" class="form-control mt-2" placeholder="Destino do lixo">
                    </fieldset>

                    <!-- Se√ß√£o III: Renda e Atividades Econ√¥micas -->
                    <fieldset class="border p-3 mb-4">
                        <legend class="w-auto text-danger"><i class="fas fa-coins"></i> Renda e Atividades Econ√¥micas
                        </legend>

                        <div class="form-group">
                            <label><strong>üíº Principais fontes de renda da fam√≠lia:</strong></label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="fontes_renda"
                                    value="Agricultura familiar" id="renda1">
                                <label class="form-check-label" for="renda1">Agricultura familiar</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="fontes_renda" value="Extrativismo"
                                    id="renda2">
                                <label class="form-check-label" for="renda2">Extrativismo (ex.: baba√ßu, a√ßa√≠,
                                    castanha)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="fontes_renda" value="Pesca"
                                    id="renda3">
                                <label class="form-check-label" for="renda3">Pesca</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="fontes_renda"
                                    value="Cria√ß√£o de animais" id="renda4">
                                <label class="form-check-label" for="renda4">Cria√ß√£o de animais</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="fontes_renda" value="Artesanato"
                                    id="renda5">
                                <label class="form-check-label" for="renda5">Artesanato</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="fontes_renda"
                                    value="Com√©rcio informal" id="renda6">
                                <label class="form-check-label" for="renda6">Com√©rcio informal</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="fontes_renda"
                                    value="Benef√≠cios sociais" id="renda7">
                                <label class="form-check-label" for="renda7">Benef√≠cios sociais (ex.: Bolsa Fam√≠lia,
                                    BPC)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="fontes_renda"
                                    value="Trabalho formal" id="renda8">
                                <label class="form-check-label" for="renda8">Trabalho formal assalariado</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="fontes_renda"
                                    value="Trabalho eventual" id="renda9">
                                <label class="form-check-label" for="renda9">Trabalho eventual/diarista</label>
                            </div>
                            <div class="form-group mt-2">
                                <input type="text" name="fontes_renda_outros" class="form-control"
                                    placeholder="Outro: descreva...">
                            </div>
                        </div>

                        <div class="form-group mt-4">
                            <label><strong>üí∞ Renda familiar total aproximada (mensal):</strong></label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="renda_mensal"
                                    value="At√© 1/4 do sal√°rio m√≠nimo" id="faixa1">
                                <label class="form-check-label" for="faixa1">At√© 1/4 do sal√°rio m√≠nimo</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="renda_mensal"
                                    value="De 1/4 a 1/2 sal√°rio m√≠nimo" id="faixa2">
                                <label class="form-check-label" for="faixa2">De 1/4 a 1/2 sal√°rio m√≠nimo</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="renda_mensal"
                                    value="De 1/2 a 1 sal√°rio m√≠nimo" id="faixa3">
                                <label class="form-check-label" for="faixa3">De 1/2 a 1 sal√°rio m√≠nimo</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="renda_mensal"
                                    value="De 1 a 2 sal√°rios m√≠nimos" id="faixa4">
                                <label class="form-check-label" for="faixa4">De 1 a 2 sal√°rios m√≠nimos</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="renda_mensal"
                                    value="Acima de 2 sal√°rios m√≠nimos" id="faixa5">
                                <label class="form-check-label" for="faixa5">Acima de 2 sal√°rios m√≠nimos</label>
                            </div>
                        </div>
                    </fieldset>


                    <!-- Se√ß√£o IV: Escolaridade e Capacita√ß√£o -->
                    <fieldset class="border p-3 mb-4">
                        <legend class="w-auto text-primary"><i class="fas fa-user-graduate"></i> Escolaridade e
                            Capacita√ß√£o</legend>

                        <div class="form-group">
                            <label><strong>üéì Grau de escolaridade do respons√°vel:</strong></label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="escolaridade_responsavel"
                                    value="Sem instru√ß√£o" id="escolaridade1">
                                <label class="form-check-label" for="escolaridade1">Sem instru√ß√£o</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="escolaridade_responsavel"
                                    value="Ensino fundamental incompleto" id="escolaridade2">
                                <label class="form-check-label" for="escolaridade2">Ensino fundamental
                                    incompleto</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="escolaridade_responsavel"
                                    value="Ensino fundamental completo" id="escolaridade3">
                                <label class="form-check-label" for="escolaridade3">Ensino fundamental completo</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="escolaridade_responsavel"
                                    value="Ensino m√©dio incompleto" id="escolaridade4">
                                <label class="form-check-label" for="escolaridade4">Ensino m√©dio incompleto</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="escolaridade_responsavel"
                                    value="Ensino m√©dio completo" id="escolaridade5">
                                <label class="form-check-label" for="escolaridade5">Ensino m√©dio completo</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="escolaridade_responsavel"
                                    value="Ensino superior incompleto/completo" id="escolaridade6">
                                <label class="form-check-label" for="escolaridade6">Ensino superior
                                    incompleto/completo</label>
                            </div>
                        </div>

                        <div class="form-group mt-4">
                            <label><strong>üìö Algu√©m na fam√≠lia j√° participou de cursos/capacita√ß√µes?</strong></label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="familia_cursos" value="1"
                                    id="cursosSim"
                                    onclick="document.getElementById('campo_cursos').style.display = 'block'">
                                <label class="form-check-label" for="cursosSim">Sim</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="familia_cursos" value="0"
                                    id="cursosNao"
                                    onclick="document.getElementById('campo_cursos').style.display = 'none'">
                                <label class="form-check-label" for="cursosNao">N√£o</label>
                            </div>

                            <div id="campo_cursos" style="display: none;" class="mt-2">
                                <input type="text" name="familia_quais_cursos" class="form-control"
                                    placeholder="Quais cursos?">
                            </div>
                        </div>
                    </fieldset>


                    <!-- Se√ß√£o V: Necessidades B√°sicas -->
                    <fieldset class="border p-3 mb-4">
                        <legend class="w-auto text-warning"><i class="fas fa-exclamation-triangle"></i> Necessidades
                            B√°sicas</legend>

                        <div class="form-group">
                            <label><strong>üõë Principais dificuldades enfrentadas atualmente:</strong></label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="dificuldades" value="Alimenta√ß√£o"
                                    id="dif1">
                                <label class="form-check-label" for="dif1">Alimenta√ß√£o</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="dificuldades" value="Sa√∫de"
                                    id="dif2">
                                <label class="form-check-label" for="dif2">Sa√∫de</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="dificuldades" value="Educa√ß√£o"
                                    id="dif3">
                                <label class="form-check-label" for="dif3">Educa√ß√£o</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="dificuldades" value="Transporte"
                                    id="dif4">
                                <label class="form-check-label" for="dif4">Transporte</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="dificuldades" value="Moradia"
                                    id="dif5">
                                <label class="form-check-label" for="dif5">Moradia</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="dificuldades"
                                    value="Emprego/renda" id="dif6">
                                <label class="form-check-label" for="dif6">Emprego/renda</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="difOutroCheck"
                                    onclick="document.getElementById('campo_dificuldade_outro').style.display = this.checked ? 'block' : 'none'">
                                <label class="form-check-label" for="difOutroCheck">Outro</label>
                            </div>
                            <input type="text" name="dificuldades_outros" id="campo_dificuldade_outro"
                                class="form-control mt-2" placeholder="Descreva outra dificuldade"
                                style="display: none;">
                        </div>
                    </fieldset>


                    <!-- Se√ß√£o VI: Potencialidades e Expectativas -->
                    <fieldset class="border p-3 mb-4">
                        <legend class="w-auto text-success"><i class="fas fa-seedling"></i> Potencialidades e
                            Expectativas</legend>

                        <div class="form-group">
                            <label><strong>üå± Quais atividades locais voc√™ acredita que poderiam gerar mais renda para a
                                    fam√≠lia?</strong></label>
                            <input type="text" name="atividades_geradoras" class="form-control"
                                placeholder="Descreva atividades produtivas ou locais">
                        </div>

                        <div class="form-group mt-4">
                            <label><strong>üí° A fam√≠lia tem interesse em participar de projetos de gera√ß√£o de
                                    renda?</strong></label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="interesse_projetos" value="1"
                                    id="interesseSim"
                                    onclick="document.getElementById('campo_areas_interesse').style.display = 'block'">
                                <label class="form-check-label" for="interesseSim">Sim</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="interesse_projetos" value="0"
                                    id="interesseNao"
                                    onclick="document.getElementById('campo_areas_interesse').style.display = 'none'">
                                <label class="form-check-label" for="interesseNao">N√£o</label>
                            </div>
                            <div id="campo_areas_interesse" class="mt-2" style="display: none;">
                                <input type="text" name="areas_interesse" class="form-control"
                                    placeholder="Se sim, em que √°reas?">
                            </div>
                        </div>

                        <div class="form-group mt-4">
                            <label><strong>üéí H√° produtos ou saberes tradicionais que poderiam ser aproveitados para
                                    aumentar a renda?</strong></label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="produtos_tradicionais" value="1"
                                    id="saberesSim"
                                    onclick="document.getElementById('campo_quais_produtos').style.display = 'block'">
                                <label class="form-check-label" for="saberesSim">Sim</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="produtos_tradicionais" value="0"
                                    id="saberesNao"
                                    onclick="document.getElementById('campo_quais_produtos').style.display = 'none'">
                                <label class="form-check-label" for="saberesNao">N√£o</label>
                            </div>
                            <div id="campo_quais_produtos" class="mt-2" style="display: none;">
                                <input type="text" name="quais_produtos" class="form-control"
                                    placeholder="Se sim, quais produtos ou saberes?">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Se√ß√£o VII: Contato para Acompanhamento -->
                    <fieldset class="border p-3 mb-4">
                        <legend class="w-auto text-info"><i class="fas fa-phone-alt"></i> Contato para Acompanhamento
                        </legend>

                        <div class="form-group">
                            <label>üìá Nome para contato</label>
                            <input type="text" name="nome_contato" class="form-control"
                                placeholder="Nome da pessoa a ser contatada">
                        </div>

                        <div class="form-group">
                            <label>üìû Telefone (se houver)</label>
                            <input type="text" name="telefone" class="form-control" placeholder="(99) 99999-9999">
                        </div>
                    </fieldset>

                </div>
                <div class="card-footer d-flex justify-content-end">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Salvar Cadastro
                    </button>
                </div>
            </div>
        </form>
    </div>
</section>



<script>
    window.addEventListener('load', function () {
        if (document.getElementById('interesseSim')?.checked)
            document.getElementById('campo_areas_interesse').style.display = 'block';
        if (document.getElementById('saberesSim')?.checked)
            document.getElementById('campo_quais_produtos').style.display = 'block';
    });
</script>



<script>
const form = document.querySelector("form");
const STORAGE_KEY = "cadastros_perfil_offline";

if (form) {
  form.addEventListener('submit', function (e) {
    if (!navigator.onLine) {
      e.preventDefault();
      salvarOffline();
    } else {
      localStorage.setItem('cadastro_perfil_sucesso', '1');
    }
  });
}

function salvarOffline() {
  const formData = new FormData(form);
  const dados = {};

  formData.forEach((value, key) => {
    if (key.endsWith("[]")) {
      const cleanKey = key.replace("[]", "");
      dados[cleanKey] = dados[cleanKey] || [];
      dados[cleanKey].push(value);
    } else {
      dados[key] = value;
    }
  });

  let registros = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
  registros.push(dados);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(registros));

  alert("‚úÖ Cadastro salvo localmente! Ser√° sincronizado quando a internet voltar.");
}

function sincronizarCadastros() {
  const registros = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
  if (registros.length === 0) return;

  registros.forEach(dados => {
    fetch("{% url 'sincronizar_perfil' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
      },
      body: JSON.stringify(dados)
    }).then(response => {
      if (response.ok) {
        console.log("‚úÖ Cadastro sincronizado.");
      }
    });
  });

  localStorage.removeItem(STORAGE_KEY);
}


const statusDiv = document.getElementById("status-conexao");

  function atualizarStatusConexao() {
    statusDiv.classList.remove("alert-success", "alert-warning");

    if (navigator.onLine) {
      statusDiv.classList.add("alert", "alert-success");
      statusDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i> Online ‚Äî envio direto para o servidor';
    } else {
      statusDiv.classList.add("alert", "alert-warning");
      statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i> Offline ‚Äî os dados ser√£o salvos localmente';
    }

    statusDiv.style.display = "block";
    statusDiv.style.position = "static";     // ‚úÖ N√£o flutuante
    statusDiv.style.marginBottom = "1rem";   // ‚úÖ Espa√ßo padr√£o
    statusDiv.style.borderRadius = "0.375rem";
    statusDiv.style.fontWeight = "500";
    statusDiv.style.fontSize = "1rem";
    statusDiv.style.padding = "0.75rem 1.25rem";
  }

window.addEventListener("load", () => {
  atualizarStatusConexao();
  sincronizarCadastros();
});

window.addEventListener("online", atualizarStatusConexao);
window.addEventListener("offline", atualizarStatusConexao);
</script>





<style>
  #status-conexao {
    margin-top: -1rem;
    margin-bottom: 1.5rem;
    border-radius: 0;
    padding: 0.75rem 1.5rem;
    font-weight: 500;
  }
</style>








{% endblock %}