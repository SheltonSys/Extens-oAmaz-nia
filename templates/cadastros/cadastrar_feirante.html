{% extends 'base.html' %}
{% load static %}

{% block title %}Cadastro de Feirantes | EXTENS√ÉO Amaz√¥nia{% endblock %}

{% block content %}
<section class="content-header">
  <div class="container-fluid">
    <h1><i class="fas fa-people-carry text-orange"></i> Cadastro de Feirantes</h1>
    <p class="text-muted">Formul√°rio para registro de informa√ß√µes sobre feiras comunit√°rias e seus impactos.</p>
  </div>
</section>



<section class="content">
  

  <div class="container-fluid">

    <div id="status-conexao" class="alert text-center shadow" style="display: none;"></div>


<!-- ALERTA DE ERRO DE C√ÇMERA -->
<div id="alerta-camera" class="alert alert-danger alert-dismissible fade show shadow text-center" role="alert" style="display:none; max-width: 600px; margin: 20px auto;">
  <strong>Erro:</strong> <div id="mensagem-erro-camera" class="mt-2"></div>
  <button type="button" class="btn-close position-absolute top-0 end-0 m-2" data-bs-dismiss="alert" aria-label="Fechar"></button>
</div>




    <form method="post">
      {% csrf_token %}
      <div class="card card-outline card-warning shadow">
        <div class="card-header">
          <h3 class="card-title"><i class="fas fa-store-alt"></i> Informa√ß√µes da Feira</h3>
        </div>

        <div class="form-group col-md-12">
  <label>üë§ Respons√°vel pelo levantamento</label>
  <input type="text" name="responsavel" class="form-control" 
         value="{{ request.user.get_full_name|default:request.user.username }}" readonly>
</div>

        <div class="card-body">

          <fieldset class="border p-3 mb-4">
            <legend class="w-auto text-orange"><i class="fas fa-info-circle"></i> Identifica√ß√£o</legend>

            <div class="form-row">
              <div class="form-group col-md-6">
                <label>üõçÔ∏è Nome da Feira</label>
                <input type="text" name="nome_feira" class="form-control">
              </div>
              <div class="form-group col-md-6">
                <label>üìç Local</label>
                <input type="text" name="local" class="form-control">
              </div>
            </div>

            <div class="form-group">
  <label><strong>‚è∞ Per√≠odo de Realiza√ß√£o</strong></label>
  <div class="form-check">
    <input class="form-check-input" type="radio" name="periodicidade" id="periodo1" value="1 vez por semana">
    <label class="form-check-label" for="periodo1">1 vez por semana</label>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="radio" name="periodicidade" id="periodo3" value="1 vez por m√™s">
    <label class="form-check-label" for="periodo3">1 vez por m√™s</label>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="radio" name="periodicidade" id="periodo2" value="2 vezes por m√™s">
    <label class="form-check-label" for="periodo2">2 vezes por m√™s</label>
  </div>

  

</div>


          </fieldset>

          <fieldset class="border p-3 mb-4">
            <legend class="w-auto text-success"><i class="fas fa-seedling"></i> Produ√ß√£o e Comercializa√ß√£o</legend>

            <div class="form-group">
              <label>ü•¨ Produtos vendidos</label>
              <textarea name="produtos" class="form-control"></textarea>
            </div>
            <div class="form-group">
              <label>üì¶ Volume comercializado</label>
              <input type="text" name="volume" class="form-control">
            </div>
            <div class="form-group">
              <label>üìà Produtos mais vendidos</label>
              <textarea name="produtos_mais_vendidos" class="form-control"></textarea>
            </div>
          </fieldset>

          <fieldset class="border p-3 mb-4">
            <legend class="w-auto text-primary"><i class="fas fa-hands-helping"></i> Impactos e Contribui√ß√µes</legend>

            <div class="form-group">
  <label><strong>üéØ Quais benef√≠cios voc√™ percebe em participar das feiras?</strong></label>

  <div class="form-check">
    <input class="form-check-input" type="checkbox" name="beneficios[]" id="beneficio1" value="Gera√ß√£o de renda e sustento familiar">
    <label class="form-check-label" for="beneficio1">
      Gera√ß√£o de renda e sustento familiar
    </label>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="checkbox" name="beneficios[]" id="beneficio2" value="Contato direto com os clientes e divulga√ß√£o dos produtos">
    <label class="form-check-label" for="beneficio2">
      Contato direto com os clientes e divulga√ß√£o dos produtos
    </label>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="checkbox" name="beneficios[]" id="beneficio3" value="Troca de experi√™ncias e fortalecimento da economia local">
    <label class="form-check-label" for="beneficio3">
      Troca de experi√™ncias e fortalecimento da economia local
    </label>
  </div>
</div>


            <div class="form-group">
  <label><strong>ü§ù Como a feira contribui para a venda dos seus produtos?</strong></label>

  <div class="form-check">
    <input class="form-check-input" type="checkbox" name="contribuicao[]" id="contribuicao1" value="Aumenta a visibilidade e facilita o contato direto com o consumidor">
    <label class="form-check-label" for="contribuicao1">
      Aumenta a visibilidade e facilita o contato direto com o consumidor
    </label>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="checkbox" name="contribuicao[]" id="contribuicao2" value="Permite vender com maior frequ√™ncia e em maior volume">
    <label class="form-check-label" for="contribuicao2">
      Permite vender com maior frequ√™ncia e em maior volume
    </label>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="checkbox" name="contribuicao[]" id="contribuicao3" value="Reduz custos com transporte e intermedia√ß√£o">
    <label class="form-check-label" for="contribuicao3">
      Reduz custos com transporte e intermedia√ß√£o
    </label>
  </div>
</div>


            <div class="form-group">
  <label><strong>üí™ A participa√ß√£o nas feiras tem ajudado no fortalecimento da sua produ√ß√£o ou organiza√ß√£o comunit√°ria? De que forma?</strong></label>

  <div class="form-check">
    <input class="form-check-input" type="checkbox" name="fortalecimento[]" id="fort1" value="Sim, fortaleceu a produ√ß√£o com aumento da demanda e incentivo ao cultivo cont√≠nuo">
    <label class="form-check-label" for="fort1">
      Sim, fortaleceu a produ√ß√£o com aumento da demanda e incentivo ao cultivo cont√≠nuo
    </label>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="checkbox" name="fortalecimento[]" id="fort2" value="Sim, contribuiu para uni√£o com outros produtores e participa√ß√£o em associa√ß√µes ou grupos">
    <label class="form-check-label" for="fort2">
      Sim, contribuiu para uni√£o com outros produtores e participa√ß√£o em associa√ß√µes ou grupos
    </label>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="checkbox" name="fortalecimento[]" id="fort3" value="N√£o houve mudan√ßas significativas na produ√ß√£o ou organiza√ß√£o comunit√°ria at√© o momento">
    <label class="form-check-label" for="fort3">
      N√£o houve mudan√ßas significativas na produ√ß√£o ou organiza√ß√£o comunit√°ria at√© o momento
    </label>
  </div>
  <br>

  <div class="form-group">
  <label><strong>üì¶ Produtos com maior aceita√ß√£o nas feiras</strong></label>

  <div class="form-check">
    <input class="form-check-input" type="checkbox" name="produtos_aceitacao[]" id="produto1" value="Hortali√ßas e verduras">
    <label class="form-check-label" for="produto1">
      Hortali√ßas e verduras (como alface, cheiro-verde, couve, etc.)
    </label>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="checkbox" name="produtos_aceitacao[]" id="produto2" value="Frutas da √©poca">
    <label class="form-check-label" for="produto2">
      Frutas da √©poca (como banana, manga, melancia, etc.)
    </label>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="checkbox" name="produtos_aceitacao[]" id="produto3" value="Produtos processados/artesanais">
    <label class="form-check-label" for="produto3">
      Produtos processados/artesanais (como farinha, doces, polpas, mel, etc.)
    </label>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="checkbox" id="produtoOutro" value="Outro">
    <label class="form-check-label" for="produtoOutro">Outros</label>
  </div>

  <!-- Campo de texto que s√≥ aparece quando "Outros" for marcado -->
  <div id="campoOutroProduto" class="mt-2" style="display: none;">
    <input type="text" class="form-control" name="produtos_aceitacao[]" placeholder="Descreva os outros produtos">
  </div>
</div>


<div class="form-group">
  <label><strong>üìç A localiza√ß√£o ou estrutura da feira favorece suas vendas? Por qu√™?</strong></label>

  <div class="form-check">
    <input class="form-check-input" type="radio" name="estrutura_feira" id="estrutura1" value="Sim, porque √© de f√°cil acesso para os clientes e tem boa circula√ß√£o de pessoas">
    <label class="form-check-label" for="estrutura1">
      Sim, porque √© de f√°cil acesso para os clientes e tem boa circula√ß√£o de pessoas
    </label>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="radio" name="estrutura_feira" id="estrutura2" value="Parcialmente, pois a localiza√ß√£o √© boa, mas a estrutura precisa de melhorias">
    <label class="form-check-label" for="estrutura2">
      Parcialmente, pois a localiza√ß√£o √© boa, mas a estrutura precisa de melhorias (como cobertura, higiene, seguran√ßa)
    </label>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="radio" name="estrutura_feira" id="estrutura3" value="N√£o, porque o local √© de dif√≠cil acesso ou mal estruturado">
    <label class="form-check-label" for="estrutura3">
      N√£o, porque o local √© de dif√≠cil acesso ou mal estruturado, o que afasta os clientes
    </label>
  </div>
</div>




</div>


          </fieldset>

          <fieldset class="border p-3 mb-4">
            <legend class="w-auto text-secondary"><i class="fas fa-tools"></i> Estrutura e Opera√ß√£o</legend>

            <div class="form-group">
              <label>üèóÔ∏è Os equipamentos e a estrutura da feira (barracas, ilumina√ß√£o, etc.) s√£o adequados? O que poderia melhorar?</label>
              <input type="text" name="estrutura_apropriada" class="form-control" placeholder="Ex: cobertura, bancas, √°gua, energia etc.">
            </div>

            <div class="form-group">
  <label><strong>‚öôÔ∏è Quais s√£o as principais dificuldades que voc√™ encontra para participar das feiras?</strong></label>

  <div class="form-check">
    <input class="form-check-input" type="checkbox" name="dificuldades[]" id="dif1" value="Falta de transporte adequado ou alto custo para deslocamento">
    <label class="form-check-label" for="dif1">
      Falta de transporte adequado ou alto custo para deslocamento
    </label>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="checkbox" name="dificuldades[]" id="dif2" value="Falta de estrutura na feira (como barracas, cobertura, √°gua, energia)">
    <label class="form-check-label" for="dif2">
      Falta de estrutura na feira (como barracas, cobertura, √°gua, energia)
    </label>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="checkbox" name="dificuldades[]" id="dif3" value="Baixo movimento de clientes ou concorr√™ncia desleal com atravessadores">
    <label class="form-check-label" for="dif3">
      Baixo movimento de clientes ou concorr√™ncia desleal com atravessadores
    </label>
  </div>
</div>


            <div class="form-group">
  <label><strong>üì¢ Como √© a comunica√ß√£o e organiza√ß√£o com os respons√°veis pela feira?</strong></label>

  <div class="form-check">
    <input class="form-check-input" type="radio" name="comunicacao" id="comunicacao1" value="Boa ‚Äì h√° di√°logo, avisos com anteced√™ncia e apoio na organiza√ß√£o">
    <label class="form-check-label" for="comunicacao1">
      Boa ‚Äì h√° di√°logo, avisos com anteced√™ncia e apoio na organiza√ß√£o
    </label>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="radio" name="comunicacao" id="comunicacao2" value="Regular ‚Äì √†s vezes h√° informa√ß√µes, mas falta mais clareza e planejamento">
    <label class="form-check-label" for="comunicacao2">
      Regular ‚Äì √†s vezes h√° informa√ß√µes, mas falta mais clareza e planejamento
    </label>
  </div>

  <div class="form-check">
    <input class="form-check-input" type="radio" name="comunicacao" id="comunicacao3" value="Ruim ‚Äì falta comunica√ß√£o, organiza√ß√£o e presen√ßa dos respons√°veis">
    <label class="form-check-label" for="comunicacao3">
      Ruim ‚Äì falta comunica√ß√£o, organiza√ß√£o e presen√ßa dos respons√°veis
    </label>
  </div>
</div>


          </fieldset>

          <fieldset class="border p-3 mb-4">
            <legend class="w-auto text-dark"><i class="fas fa-university"></i> Apoios e Sugest√µes</legend>

            <div class="form-group">
              <label>üèõÔ∏è Voc√™ sente que h√° apoio suficiente por parte das institui√ß√µes locais ou da organiza√ß√£o da feira?</label>
              <textarea name="apoio_institucional" class="form-control"></textarea>
            </div>
            <div class="form-group">
              <label>‚ùó J√° enfrentou problemas com a aceita√ß√£o dos seus produtos ou com o p√∫blico consumidor?</label>
              <textarea name="problemas_aceitacao" class="form-control"></textarea>
            </div>
            <div class="form-group">
              <label>üí¨ O que voc√™ sugeriria para melhorar sua experi√™ncia e os resultados da participa√ß√£o nas feiras?</label>
              <textarea name="sugestoes" class="form-control" placeholder="Recomenda√ß√µes para melhorias, a√ß√µes e eventos"></textarea>
            </div>
          </fieldset>


          <fieldset class="border p-3 mb-4">
  <legend class="w-auto text-primary"><i class="fas fa-camera"></i> Foto de Evid√™ncia</legend>

  <div class="form-group text-center">
    <video id="video" width="100%" height="240" autoplay class="border rounded mb-2"></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <input type="hidden" name="foto_base64" id="foto_base64">
    
    <div class="btn-group mt-2" role="group">
      <button type="button" class="btn btn-outline-primary" onclick="capturarFoto()">
        <i class="fas fa-camera"></i> Tirar Foto
      </button>
      <button type="button" class="btn btn-outline-danger" onclick="desligarCamera()">
        <i class="fas fa-power-off"></i> Desligar C√¢mera
      </button>
      <button type="button" class="btn btn-outline-secondary" onclick="alternarCamera()">
        <i class="fas fa-sync-alt"></i> Alternar C√¢mera
      </button>
    </div>
  </div>

  <div id="preview" class="text-center mt-3" style="display:none;">
    <p class="text-success"><i class="fas fa-check-circle"></i> Foto capturada com sucesso!</p>
    <img id="foto_preview" src="#" alt="Pr√©via da Foto" class="img-thumbnail" style="max-width: 100%;">
  </div>
</fieldset>





        </div>
        <div class="card-footer d-flex justify-content-end">
          <button type="submit" class="btn btn-success">
            <i class="fas fa-save"></i> Salvar Cadastro
          </button>
        </div>
      </div>
    </form>
  </div>




</section>


<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">





<script>
  const outroCheckbox = document.getElementById('produtoOutro');
  const campoOutro = document.getElementById('campoOutroProduto');

  outroCheckbox.addEventListener('change', function () {
    campoOutro.style.display = this.checked ? 'block' : 'none';
    const input = campoOutro.querySelector('input');
    if (!this.checked) input.value = '';  // limpa se desmarcado
  });
</script>


<script>
  let stream = null;
  let usandoFrontal = true;

  async function iniciarCamera() {
    try {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }

      const constraints = {
        video: {
          facingMode: usandoFrontal ? "user" : "environment"
        },
        audio: false
      };

      stream = await navigator.mediaDevices.getUserMedia(constraints);
      document.getElementById('video').srcObject = stream;

    } catch (err) {
      exibirErroCamera("N√£o foi poss√≠vel acessar a c√¢mera. O seu navegador pode n√£o suportar este recurso ou o acesso foi bloqueado. Verifique se est√° usando um navegador compat√≠vel e se a conex√£o √© segura (HTTPS).");

    }
  }

  function desligarCamera() {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      stream = null;
      document.getElementById('video').srcObject = null;
    }
  }

  function alternarCamera() {
    usandoFrontal = !usandoFrontal;
    iniciarCamera();
  }

  function capturarFoto() {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const fotoBase64 = document.getElementById('foto_base64');
    const preview = document.getElementById('preview');
    const fotoPreview = document.getElementById('foto_preview');

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

    const imagemBase64 = canvas.toDataURL('image/png');
    fotoBase64.value = imagemBase64;
    fotoPreview.src = imagemBase64;
    preview.style.display = "block";
  }

  // Iniciar a c√¢mera automaticamente ao carregar a p√°gina
  document.addEventListener('DOMContentLoaded', iniciarCamera);
</script>


<script>
  const statusDiv = document.getElementById("status-conexao");

  function atualizarStatusConexao() {
    if (navigator.onLine) {
      statusDiv.className = "alert alert-success text-center shadow";
      statusDiv.innerHTML = "‚úÖ Conectado ‚Äî cadastros ser√£o enviados normalmente.";
    } else {
      statusDiv.className = "alert alert-warning text-center shadow";
      statusDiv.innerHTML = "‚ö†Ô∏è Voc√™ est√° offline ‚Äî os dados ser√£o salvos localmente.";
    }
    statusDiv.style.display = "block";
  }

  window.addEventListener("load", atualizarStatusConexao);
  window.addEventListener("online", atualizarStatusConexao);
  window.addEventListener("offline", atualizarStatusConexao);
</script>




<script>
  const form = document.querySelector("form");
  const STORAGE_KEY = "cadastros_feirante_offline";

  function isOffline() {
    return !navigator.onLine;
  }

  function salvarOffline() {
    const formData = new FormData(form);
    const dados = {};
    formData.forEach((value, key) => {
      if (key.endsWith("[]")) {
        const cleanKey = key.replace("[]", "");
        dados[cleanKey] = dados[cleanKey] || [];
        dados[cleanKey].push(value);
      } else {
        dados[key] = value;
      }
    });

    let registros = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    registros.push(dados);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(registros));

    alert("‚úÖ Cadastro salvo localmente! Ser√° sincronizado quando a internet voltar.");
  }

  function sincronizarCadastros() {
    const registros = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    if (registros.length === 0) return;

    registros.forEach(dados => {
      fetch("/sincronizar/feirante/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify(dados)
      }).then(response => {
        if (response.ok) {
          console.log("‚úÖ Sincronizado com sucesso");
        }
      });
    });

    localStorage.removeItem(STORAGE_KEY);
  }

  form.addEventListener("submit", function (e) {
    if (isOffline()) {
      e.preventDefault();
      salvarOffline();
    }
  });

  window.addEventListener("online", sincronizarCadastros);
</script>



<script>
function exibirErroCamera(mensagem) {
  const alerta = document.getElementById("alerta-camera");
  const spanMensagem = document.getElementById("mensagem-erro-camera");

  spanMensagem.textContent = mensagem;
  alerta.style.display = "block";

  // Oculta ap√≥s 6 segundos
  setTimeout(() => {
    alerta.style.display = "none";
  }, 6000);
}

</script>


{% endblock %}
